<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>Chat</title>
<link rel="stylesheet" href="css/style.css">
<link rel="icon" type="img/png" href="img/favicon.png">
</head>

<body>
<!-- ãƒ˜ãƒƒãƒ€ãƒ¼ ã“ã“ã‹ã‚‰-->
  <header>
    <div class="chat_container">
        <div class="item">
            <div class="left"><img src="img/chat_left.png" alt="">
            </div>
        </div>
        <div class="item">
            <div class="center">
                <h1 class="page-title">Let's Chat</h1>
            </div>
        </div>
        <div class="item">
            <div class="right"><img src="img/chat_right.png" alt="">
            </div>
        </div>
    </div>
</header>
<!-- ãƒ˜ãƒƒãƒ€ãƒ¼ ã“ã“ã¾ã§-->

<!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„è¡¨ç¤ºç”»é¢ ã“ã“ã‹ã‚‰-->
<!-- JavaScriptã§æ‰±ã†ã‚‚ã®ã¯å¿…ãšidã‚’ã¤ã‘ã‚‹ -->
<!-- idã‚’ã¤ã‘ã‚‹ã®ã¯ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºé ˜åŸŸã®#outputã€ãƒ†ã‚­ã‚¹ãƒˆãƒœãƒƒã‚¯ã‚¹ã®unameã€ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®#textã€ãƒœã‚¿ãƒ³ã®#send -->
<div class="chat_wrapper">
  <!-- ãƒãƒ£ãƒƒãƒˆã®å†…å®¹ã‚’è¡¨ç¤ºã™ã‚‹ ã“ã“ã‹ã‚‰-->
  <div id="output"></div>
  <!-- ãƒãƒ£ãƒƒãƒˆã®å†…å®¹ã‚’è¡¨ç¤ºã™ã‚‹ ã“ã“ã¾ã§-->

  <!-- ãƒãƒ£ãƒƒãƒˆã®å†…å®¹ã‚’å…¥åŠ›ã™ã‚‹ ã“ã“ã‹ã‚‰-->
  <div class="input_chat">
    <div class="input_uname"> 
      <label for="uname">ãªã¾ãˆï¼š</label>
      <input type="text" id="uname"> 
    </div>

    <div class="input_text">
      <textarea id="text" cols="30" rows="10"></textarea>
    </div>

    <div class="send">
      <button id="send">é€ä¿¡</button>
    </div>
  </div>
  <!-- ãƒãƒ£ãƒƒãƒˆã®å†…å®¹ã‚’å…¥åŠ›ã™ã‚‹ ã“ã“ã¾ã§-->
</div>
<!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„è¡¨ç¤ºç”»é¢ ã“ã“ã¾ã§-->

<!-- ãƒ•ãƒƒã‚¿ãƒ¼ ã“ã“ã‹ã‚‰-->
<footer>
  <small>Copyrights 2024 *** All RIghts Reserved.</small>
</footer>
<!-- ãƒ•ãƒƒã‚¿ãƒ¼ ã“ã“ã¾ã§-->

<!-- JQuery ã‚’ä½¿ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹(ä»Šå›ã¯CDNã‹ã‚‰èª­ã¿è¾¼ã‚€) ã“ã“ã‹ã‚‰-->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<!-- JQuery ã‚’ä½¿ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹(ä»Šå›ã¯CDNã‹ã‚‰èª­ã¿è¾¼ã‚€) ã“ã“ã¾ã§-->

<!-- Firebase ã‹ã‚‰ã‚³ãƒ”ãƒ¼ã—ã¦ããŸã‚¹ã‚¯ãƒªãƒ—ãƒˆ ã“ã“ã‹ã‚‰-->
<script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp }
  from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
  // ç›´ä¸Šã®ã‚³ãƒ¼ãƒ‰2è¡Œã¯ã€firebase-app.jsã‚’èª­ã¿è¾¼ã‚“ã§æœ€å°é™ã®ã‚³ã‚¢ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’èª­ã¿è¾¼ã‚“ã§ã„ã‚‹ã€‚

  // Firebaseã®Ver.9ä»¥é™ã€ä»•æ§˜å¤‰æ›´ãŒã‚ã‚Šã€ã‚³ãƒ¼ãƒ‰2è¡Œã‚’è¿½åŠ ã™ã‚‹å¿…è¦ã‚ã‚Šã€‚
  // ã¾ãšã€firebase-database.jsã‚’èª­ã¿è¾¼ã¿ã€RealtimeDatabaseã‚’ä½¿ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚fromã®è¡Œã€‚
  // importã§åˆ©ç”¨ã™ã‚‹é–¢æ•°ã‚’å®£è¨€ã—ã€åˆ©ç”¨ã§ãã‚‹çŠ¶æ…‹ã«ã™ã‚‹ã€‚å®£è¨€ã—ãŸé–¢æ•°ã—ã‹ä½¿ãˆãªã„ã®ã§ä½¿ã†ã‚‚ã®ã‚’å®£è¨€ã™ã‚‹ã€‚importã®è¡Œã€‚
  import { getDatabase, ref, push, set, update, remove, onChildAdded, onChildChanged , onChildRemoved } 
  from "https://www.gstatic.com/firebasejs/10.8.1/firebase-database.js";
  
  // TODO: Add SDKs for Firebase products that you want to use
  // https://firebase.google.com/docs/web/setup#available-libraries

  // Your web app's Firebase configuration

  // é–¢æ•°initializeAppã«å¼•æ•°ã¨ã—ã¦ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå‹å¤‰æ•°firebaseConfigæ¸¡ã™ã€‚
  // ã“ã‚Œã§è‡ªåˆ†ç”¨ã«ä½œæˆã—ãŸKeyã§ã‚‚ã£ã¦Firebaseã«æ¥ç¶šã§ãã‚‹ã‚ˆã†ã«ãªã‚‹
  const app = initializeApp(firebaseConfig); 
  // Firebase ã‹ã‚‰ã‚³ãƒ”ãƒ¼ã—ã¦ããŸã‚¹ã‚¯ãƒªãƒ—ãƒˆ ã“ã“ã¾ã§(ä¸€éƒ¨è¿½è¨˜ã‚ã‚Š)

  //LINEé¢¨ãƒãƒ£ãƒƒãƒˆå‡¦ç†ã®ã‚³ãƒ¼ãƒ‰ ã“ã“ã‹ã‚‰
  // Firebaseã«æ¥ç¶šã—ãŸå¾Œã€é–¢æ•°getDatabaseã«å¼•æ•°appã‚’ã„ã‚Œã¦RealtimDatabaseã«æ¥ç¶šã™ã‚‹ã€‚
  const db = getDatabase(app);

  // RealtimeDBå†…ã®ã©ã“ã®éšå±¤ã«ãƒ‡ãƒ¼ã‚¿ã‚’å…¥ã‚Œã‚‹ã‹ã‚’æŒ‡å®šã™ã‚‹ã€‚ä»Šå›ã¯chatã¨ã„ã†éšå±¤ã‚’æŒ‡å®šã™ã‚‹ã€‚
  const dbRef = ref(db,"chat");

  // 1-a. ãƒ‡ãƒ¼ã‚¿ã®é€ä¿¡ã‚¤ãƒ™ãƒ³ãƒˆ(ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ç™»éŒ²ï¼‰
  $("#send").on("click",function(){
    const msg ={ //ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå‹ã®å¤‰æ•°msgã‚’å®šç¾©ã™ã‚‹ã€‚
      uname :$("#uname").val(), //id unameã®å€¤(value)ã‚’å–å¾—ã—ã¦unameã«ã„ã‚Œã‚‹ã€‚
      text  :$("#text").val(), //id textã®å€¤(value)ã‚’å–å¾—ã—ã¦textã«ã„ã‚Œã‚‹ã€‚
      sent_at: new Date().toISOString() //ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã—ãŸæ™‚é–“ã‚’å–å¾—ã™ã‚‹ã€‚
    }
    const newPostRef = push(dbRef); //ãƒãƒ£ãƒƒãƒˆã«é€ã‚‹ãƒ‡ãƒ¼ã‚¿ã«ã¯ãƒ¦ãƒ‹ãƒ¼ã‚¯KEYã‚’ã¤ã‘ãŸã„ã®ã§ãƒ¦ãƒ‹ãƒ¼ã‚¯keyã‚’ç”Ÿæˆã™ã‚‹ã€‚
    set(newPostRef,msg); //é–¢æ•°set()ã‚’ä½¿ã£ã¦Firebaseã®RealtimeDatabaseã«"chat"ã«ãƒ¦ãƒ‹ãƒ¼ã‚¯KEYã‚’ã¤ã‘ã¦ã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå‹å¤‰æ•°msgã‚’valueã¨ã—ã¦ã‚»ãƒƒãƒˆ(ç™»éŒ²)ã™ã‚‹ã€‚
  });

  // 1-b. ãƒ‡ãƒ¼ã‚¿ã®å—ä¿¡ï¼ˆæœ€åˆã«ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼†onSnapshotã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã«ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼‰
  onChildAdded(dbRef,function(data){ //é–¢æ•°onChildAdded()ã§RealtimeDatabaseã«é€ä¿¡ã•ã‚Œã¦ãã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’ç›£è¦–ã™ã‚‹ã€‚RealtimeDatabaseã«ãƒ‡ãƒ¼ã‚¿ãŒå…¥ã£ã¦ããŸã‚‰dataãŒè‡ªå‹•çš„ã«å…¥ã‚‹
    const msg = data.val(); //DataãŒå…¥ã£ã¦ããŸã‚‰ã€é–¢æ•°data.val()ã‚’ä½¿ã£ã¦ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå¤‰æ•°ã‚’å–å¾—ã—ã€å¤‰æ•°msgã«ä»£å…¥ã™ã‚‹ã€‚
    const key = data.key; //ãƒ‡ãƒ¼ã‚¿ã®ãƒ¦ãƒ‹ãƒ¼ã‚¯keyã‚’å–å¾—ã™ã‚‹ï¼ˆå‰Šé™¤ã‚„æ›´æ–°ã«å¿…é ˆï¼ï¼ï¼‰ã€‚keyã®å¾Œã«()ã¯ã¤ã‘ãªãã¦ã‚ˆã„ã€‚
    // è¡¨ç¤ºã™ã‚‹HTMLã‚’å¤‰æ•°hã¨ã—ã¦ä½œæˆã—ã€id outputã«é–¢æ•°appendã«æ¸¡ã—ã¦ã€è¡¨ç¤ºã•ã›ã‚‹
    let h =  '<p id="'+key+'">'; //pã‚¿ã‚°ã«idã¨ã—ã¦ã‚­ãƒ¼ã‚’æŒãŸã›ã¦ã„ã‚‹ã€‚å‰Šé™¤ã—ãŸã¨ãã«ã»ã‹ã®äººã®ãƒãƒ£ãƒƒãƒˆã‹ã‚‰ã‚‚æ¶ˆã™ãŸã‚ã«idãŒå¿…è¦ã€‚
        h += '<span contentEditable="true" id="'+key+'_update">'+ msg.text+'</span>'; //æ›´æ–°ã™ã‚‹ã¨ãã®ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ãŒä¼¸ã³ã‚‹ï¼
        h += '<span class="remove" data-key="'+key+'">ğŸš®</span>' 
        h += '<span class="update" data-key="'+key+'">ğŸ†™</span>'
        h += '<br>';
        h += msg.uname;
        h += '<span> : '+new Date(msg.sent_at).toLocaleString();
        h += '</p>';
        // $("#output").prepend(h);
        $("#output").append(h); //id outputã®æœ€å¾Œã«è¿½åŠ ã™ã‚‹
  });

  // 2-a å‰Šé™¤ã‚¤ãƒ™ãƒ³ãƒˆ
  $("#output").on("click", ".remove", function(){ // id output(ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã—ã¦ã„ã‚‹ã‚¨ãƒªã‚¢ï¼‰ã®ã‚¯ãƒ©ã‚¹remove(ã”ã¿ç®±ï¼‰ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‚‰
      const key = $(this).attr("data-key"); // ã‚¯ãƒªãƒƒã‚¯ã—ãŸã¨ã“ã‚(this)ã«åŸ‹ã‚è¾¼ã¾ã‚Œã¦ã„ã‚‹ã‚­ãƒ¼ã‚’å–å¾—ã™ã‚‹ã€‚
      const remove_item = ref(db,"chat/"+key); // é–¢æ•°ref()ã‚’ä½¿ã£ã¦å ´æ‰€ã‚’ç›£è¦–ã—ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹chatã®ãªã‹ã®ãƒ¦ãƒ‹ãƒ¼ã‚¯keyã‚’å¤‰æ•°remove_itemã«å…¥ã‚Œã‚‹ã€‚
      remove(remove_item); // Firebaseã®ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ã™ã‚‹é–¢æ•°removeã‚’ä½¿ã£ã¦å‰Šé™¤ã™ã‚‹ã€‚
  });

  // 2-b å‰Šé™¤å‡¦ç†ãŒFirebaseå´ã§å®Ÿè¡Œã•ã‚ŒãŸã‚‰ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿ
  onChildRemoved(dbRef, (data) => { // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å´ã§å‰Šé™¤ã•ã‚ŒãŸ(Removed)ã“ã¨ã‚’æ¤œçŸ¥ã—ã¦
    $("#"+data.key).remove(); // DOMæ“ä½œé–¢æ•°remove()ã‚’ä½¿ã£ã¦å¯¾è±¡"#"+data.keyï¼ˆã“ã®idã¯pã‚¿ã‚°ã«ã¤ã‘ã‚‰ã‚Œã¦ã„ã‚‹ã®ã§ãã®pã‚¿ã‚°ã§å›²ã¾ã‚ŒãŸéƒ¨åˆ†ã‚’ã¾ã‚‹ã£ã¨ï¼‰ã‚’å‰Šé™¤ã™ã‚‹ã€‚
  });

  // 3-a æ›´æ–°ã‚¤ãƒ™ãƒ³ãƒˆ
  $("#output").on("click", ".update", function(){ // id output(ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã—ã¦ã„ã‚‹ã‚¨ãƒªã‚¢ï¼‰ã®ã‚¯ãƒ©ã‚¹updateãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‚‰
      const key = $(this).attr("data-key"); // ã‚¯ãƒªãƒƒã‚¯ã—ãŸã¨ã“ã‚(this)ã«åŸ‹ã‚è¾¼ã¾ã‚Œã¦ã„ã‚‹ã‚­ãƒ¼ã‚’å–å¾—ã™ã‚‹ã€‚
      update(ref(db,"chat/"+key),{ // é–¢æ•°ref()ã‚’ä½¿ã£ã¦ã©ã“ã®ã‚­ãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã™ã‚‹ã‹
        text: $("#"+key+'_update').html() // id "#"+key+'_update'ï¼ˆå¯å¤‰ã§ãƒ†ã‚­ã‚¹ãƒˆã‚’ç·¨é›†ã§ãã‚‹ã¨ã“ã‚ï¼‰ã®htmlï¼ˆä¸­ã®æ–‡å­—åˆ—ã‚’ï¼‰å–å¾—ã—ã¦æ›´æ–°ï¼ˆæ›¸ãæ›ãˆï¼‰ã™ã‚‹ã€‚
      })
  });

  // 3-b æ›´æ–°å‡¦ç†ãŒFirebaseå´ã§å®Ÿè¡Œã•ã‚ŒãŸã‚‰ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿ
  onChildChanged(dbRef, (data) => { // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å´ã§ä½•ã‹å¤‰æ›´(Changed)ãŒã‚ã£ãŸã“ã¨ã‚’æ¤œçŸ¥ã—ã¦
    $("#"+data.key+'_update').html(data.val().text); // id "#"+data.key+'_update'ã®ã¨ã“ã‚ã®htmlã‚’data.valã®ä¸­ã®textã«æ›¸ãæ›ãˆã‚‹ã€‚
    $("#"+data.key+'_update').fadeOut(800).fadeIn(800); // æ›¸ãæ›ã‚ã£ãŸéƒ¨åˆ†ã‚’fadeOutã¨fadeInã§æ•™ãˆã¦ã‚ã’ã‚‹ã€‚
  });

</script>
</body>
</html>
































